DGPMAPI8 ;RGI/VSL - PATIENT MOVEMENT API; 4/18/13
 ;;5.3;Registration;**260005**;
GETLASTM(RETURN,DFN,DGDT,ADT) ; Get last patient movement
 N %,DGDT1,LMVT,MVT,FLDS,ADM,RPM,PAT
 K RETURN S RETURN=0
 S %=$$CHKPAT^DGPMAPI8(.RETURN,$G(DFN),"DFN") Q:'RETURN 0
 S %=$$VALDT^DGPMAPI8(.RETURN,.DGDT,"DGDT") Q:'RETURN 0
 I '$D(DGDT) D NOW^%DTC S DGDT=%
 S DGDT1=9999999.999999-DGDT
 D GETLASTM^DGPMDAL1(.LMVT,+DFN,DGDT1,.ADT)
 Q:LMVT(1)'>0 1
 D GETPAT^DGPMDAL2(.PAT,+DFN,"401.3")
 S RETURN("SERILL")=PAT(401.3,"I")_U_PAT(401.3,"E")
 D GETMVT^DGPMDAL1(.MVT,+LMVT(1),".04")
 S RETURN("MTYPE")=MVT(.04,"I")_U_MVT(.04,"E")
 S RETURN("MFN")=LMVT(1)
 S RETURN("TYPE")=LMVT(2)
 S RETURN("DATE")=LMVT(3)
 S RETURN("MASTYPE")=LMVT(4)
 S RETURN("WARD")=LMVT(5)
 S RETURN("ROOMBED")=LMVT(6)
 S RETURN("PRYMPHY")=LMVT(7)
 S RETURN("FTSPEC")=LMVT(8)
 S RETURN("ADMIFN")=LMVT(13)
 S RETURN("ADMDT")=LMVT(13,1)
 S RETURN("DISIFN")=LMVT(17)
 D GETMVT^DGPMDAL1(.MVT,+LMVT(17),".01;.04")
 I LMVT(17)'=LMVT(1) D
 . S RETURN("DISDT")=$G(MVT(.01,"I"))
 S:LMVT(17)=LMVT(1) RETURN("DISDT")=LMVT(3)
 S RETURN("DISTYPE")=$G(MVT(.04,"E"))
 S RETURN("ATNDPHY")=LMVT(18)
 S RETURN("FDEXC")=LMVT(19,1)
 S RETURN=1
 Q 1
 ;
GETPMVT(RETURN,AFN,DGDT,MFN) ; Get prior movement
 N MVT,FLDS,NAMES,PMVT,ID
 K RETURN S RETURN=0
 S FLDS=".01;.02;.03;.04;.06;.07;.1;.11;.12;.15;.17;.18;41;.16;54"
 S NAMES="DATE;TTYPE;PATIENT;TYPE;WARD;ROOMBED;SHDIAG;ADMSCC;ADMREG;ASIH;DISCH;MASTYPE;FDEXC;PTF;ADMCAT"
 D GETMVT^DGPMDAL1(.MVT,+$G(AFN),FLDS) Q:MVT=0 0
 D GETPMVT^DGPMDAL3(.PMVT,MVT(.03,"I"),+AFN,.DGDT,.MFN,FLDS)
 I PMVT=0 M RETURN=PMVT Q 0
 S ID=PMVT("ID") K PMVT("ID")
 D BUILD(.RETURN,.PMVT,FLDS,NAMES)
 S RETURN("ID")=ID
 S RETURN=1
 Q 1
GETNMVT(RETURN,AFN,DGDT,MFN) ; Get next movement
 N MVT,FLDS,NAMES,NMVT
 K RETURN S RETURN=0
 S FLDS=".01;.02;.03;.04;.06;.07;.1;.11;.12;.17;.18;41;.16;54"
 S NAMES="DATE;TTYPE;PATIENT;TYPE;WARD;ROOMBED;SHDIAG;ADMSCC;ADMREG;DISCH;MASTYPE;FDEXC;PTF;ADMCAT"
 D GETMVT^DGPMDAL1(.MVT,+$G(AFN),FLDS) Q MVT=0
 D GETNMVT^DGPMDAL3(.NMVT,MVT(.03,"I"),+AFN,.DGDT,.MFN,FLDS)
 I NMVT=0 M RETURN=NMVT Q 0
 S ID=NMVT("ID") K NMVT("ID")
 D BUILD(.RETURN,.NMVT,FLDS,NAMES)
 S RETURN("ID")=ID
 S RETURN=1
 Q 1
GETPAT(RETURN,DFN) ; Get patient
 K RETURN N IND,NAME,FLDS,NAMES,PAT
 S FLDS=".01;.02;.03;.05;.06;.08;.14;.351;.361;.3611;.323;401.3;.1"
 S NAMES="NAME;SEX;DOB;MSTAT;RACE;RELIG;MEANST;DTHDT;ELIG;ESTAT;POFSRV;SRILL;WARD"
 S %=$$CHKPAT^DGPMAPI8(.RETURN,$G(DFN),"DFN") Q:'RETURN 0
 D GETPAT^DGPMDAL2(.PAT,+DFN,FLDS)
 D BUILD(.RETURN,.PAT,FLDS,NAMES)
 S RETURN=1
 Q 1
 ;
GETADM(RETURN,AFN) ; Get admission
 K RETURN N IND,NAME,FLDS,NAMES,MVT,RPHY,RPHYMVT,DIAG,PTF
 S FLDS=".01;.02;.03;.04;.05;.06;.07;.1;.11;.12;.17;.18;.21;30.01;30.02;30.03;41;.16;54"
 S NAMES="DATE;TTYPE;PATIENT;TYPE;FCTY;WARD;ROOMBED;SHDIAG;ADMSCC;ADMREG;DISCH;MASTYPE;ASIHTRA;LDGRSN;LDGCOMM;LDGDISP;FDEXC;PTF;ADMCAT"
 I '$G(AFN) S RETURN=0,TXT(1)="AFN" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETMVT^DGPMDAL1(.MVT,+$G(AFN),FLDS)
 I MVT=0 S RETURN=0 D ERRX^DGPMAPIE(.RETURN,"ADMNFND") Q 0
 D BUILD(.RETURN,.MVT,FLDS,NAMES)
 I MVT(.02,"I")=4 S RETURN=1 Q 1
 D GETPTF^DGPMDAL1(.PTF,+RETURN("PTF"),"20;20.1")
 S RETURN("ADMSRC")=PTF(20,"I")_U_PTF(20,"E")
 S RETURN("ELIGIB")=PTF(20.1,"I")_U_PTF(20.1,"E")
 D GETPAT^DGPMDAL2(.PAT,+RETURN("PATIENT"),"401.3")
 S RETURN("SERILL")=PAT(401.3,"I")_U_PAT(401.3,"E")
 S FLDS=".08;.09;.19"
 S NAMES="PRYMPHY;FTSPEC;ATNDPHY"
 S RPHY=$$GETRPHY^DGPMDAL1(AFN)
 D GETMVT^DGPMDAL1(.RPHYMVT,RPHY,FLDS)
 D GETDIAG^DGPMDAL2(.DIAG,RPHY)
 M RETURN("DIAG")=DIAG(99)
 D BUILD(.RETURN,.RPHYMVT,FLDS,NAMES)
 S RETURN=1
 Q 1
 ;
GETTRA(RETURN,TFN) ; Get transfer
 K RETURN N IND,NAME,FLDS,NAMES,MVT,RPHY,RPHYMVT,DIAG
 S FLDS=".01;.02;.03;.04;.05;.06;.07;.13;.14;.18;"
 S NAMES="DATE;TTYPE;PATIENT;TYPE;FCTY;WARD;ROOMBED;RABSDT;ADMIFN;MASTYPE;"
 I '$G(TFN) S RETURN=0,TXT(1)="TFN" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETMVT^DGPMDAL1(.MVT,+$G(TFN),FLDS)
 I MVT=0 S RETURN=0 D ERRX^DGPMAPIE(.RETURN,"TRANFND") Q 0
 D BUILD(.RETURN,.MVT,FLDS,NAMES)
 D GETPAT^DGPMDAL2(.PAT,+RETURN("PATIENT"),"401.3")
 S RETURN("SERILL")=PAT(401.3,"I")_U_PAT(401.3,"E")
 S FLDS=".08;.09;.19"
 S NAMES="PRYMPHY;FTSPEC;ATNDPHY"
 S RPHY=$$GETRPHY^DGPMDAL1(+TFN)
 I $G(RPHY)>0 D
 . D GETMVT^DGPMDAL1(.RPHYMVT,RPHY,FLDS)
 . D GETDIAG^DGPMDAL2(.DIAG,RPHY)
 . M RETURN("DIAG")=DIAG(99)
 . D BUILD(.RETURN,.RPHYMVT,FLDS,NAMES)
 S RETURN=1
 Q 1
 ;
GETMVT(RETURN,MFN) ; Get movement
 K RETURN N IND,NAME,FLDS,NAMES,MVT,RPHY,RPHYMVT,DIAG
 S FLDS=".01;.02;.03;.04;.05;.06;.07;.08;.09;.1;.14;.17;.18;.19;.24;30.01;30.02;30.03;"
 S NAMES="DATE;TTYPE;PATIENT;TYPE;FCTY;WARD;ROOMBED;PRYMPHY;FTSPEC;"
 S NAMES=NAMES_"SHDIAG;ADMIFN;DISCH;MASTYPE;ATNDPHY;RPM;LDGRSN;LDGCOMM;LDGDISP;"
 I '$G(MFN) S RETURN=0,TXT(1)="MFN" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETMVT^DGPMDAL1(.MVT,+MFN,FLDS)
 I MVT=0 S RETURN=0 D ERRX^DGPMAPIE(.RETURN,"MVTNFND") Q 0
 D BUILD(.RETURN,.MVT,FLDS,NAMES)
 D GETDIAG^DGPMDAL2(.DIAG,MFN)
 M:$D(DIAG(99)) RETURN("DIAG")=DIAG(99)
 S RETURN=1
 Q 1
 ;
GETMVTT(RETURN,IFN) ; Get movement type
 K RETURN N IND,NAME,FLDS,NAMES,MVT,RPHY,RPHYMVT
 S FLDS=".01;.02;.03;.04;.05;.07;"
 S NAMES="NAME;TTYPE;MAS;STAT;ASKSPEC;PNAME"
 I '$G(IFN) S RETURN=0,TXT(1)="IFN" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETMVTT^DGPMDAL2(.MVT,+$G(IFN),FLDS)
 I MVT=0 S RETURN=0 D ERRX^DGPMAPIE(.RETURN,"MVTTNFND") Q 0
 D BUILD(.RETURN,.MVT,FLDS,NAMES)
 S RETURN=1
 Q 1
 ;
GETPSRV(RETURN,IFN) ; Get period of service
 K RETURN N IND,NAME,FLDS,NAMES,MVT,RPHY,RPHYMVT
 S FLDS=".01;.02;.03;.04;.05;"
 S NAMES="NAME;ABV;CODE;BEGDT;ENDDT"
 I '$G(IFN) S RETURN=0,TXT(1)="IFN" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETPSRV^DGPMDAL2(.MVT,+$G(IFN),FLDS)
 I MVT=0 S RETURN=0 D ERRX^DGPMAPIE(.RETURN,"PSRVNFND") Q 0
 D BUILD(.RETURN,.MVT,FLDS,NAMES)
 S RETURN=1
 Q 1
 ;
GETMASMT(RETURN,IFN) ; Get MAS movement type
 K RETURN N IND,NAME,FLDS,NAMES,MVT
 S FLDS=".01;.02;.05;.06;50.01;50.02;50.03;"
 S NAMES="NAME;TTYPE;ASKSPEC;ASKFTY;ABS;CFADM;ASIH"
 I '$G(IFN) S RETURN=0,TXT(1)="IFN" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETMASMT^DGPMDAL2(.MVT,+$G(IFN),FLDS)
 I MVT=0 S RETURN=0 D ERRX^DGPMAPIE(.RETURN,"MVTTNFND") Q 0
 D BUILD(.RETURN,.MVT,FLDS,NAMES)
 S RETURN=1
 Q 1
 ;
BUILD(RETURN,REC,FLDS,NAMES) ; 
 N IND
 F IND=0:0 S IND=$O(REC(IND)) Q:IND=""  D
 . S NAME=$$FLDNAME^SDMUTL(FLDS,NAMES,IND)
 . S RETURN(NAME)=REC(IND,"I")_$S(REC(IND,"I")=REC(IND,"E"):"",1:U_REC(IND,"E"))
 Q
ISDOM(RETURN,DFN,DGDT) ; Is patient on dom?
 K RETURN N VAINDT,VADMVT,DGDOM,DGDOM1
 S:$D(DGDT) VAINDT=DGDT
 S DFN=+DFN,DGDT=+DGDT
 D DOM^DGMTR
 S RETURN=$G(DGDOM)
 Q 1
 ;
HASMVT(DFN,DGPMT) ; Has movement?
 Q $$HASMVT^DGPMDAL3(+$G(DFN),+$G(DGPMT))
 ;
CHKWARD(RETURN,WARD,DATE) ; Check ward
 N TMP,TXT K RETURN S RETURN=0
 I $G(WARD)="" S TXT(1)="PARAM('WARD')" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETWARD^DGPMDAL2(.TMP,+WARD,".01;400;200*")
 I TMP=0 D ERRX^DGPMAPIE(.RETURN,"WRDNFND") Q 0
 I TMP=1,TMP(400,"I")="" D ERRX^DGPMAPIE(.RETURN,"WRDINVGL",.TXT) Q 0
 I TMP=1,$D(TMP("OOS")),'$$ISWRDACT^DGPMAPI7(.TMP,+DATE) D ERRX^DGPMAPIE(.RETURN,"WRDINACT") Q 0
 S RETURN=1
 Q 1
 ;
CHKBED(RETURN,BED,WARD,DFN,DATE) ; Check bed
 N TMP,TXT K RETURN S RETURN=0
 D GETWARD^DGPMDAL2(.TMP,+$G(WARD),".01;")
 N ERR,WN S WN=$G(TMP(.01,"E")) K TMP
 D GETBED^DGPMDAL2(.TMP,+$G(BED),".01;.2;100*;200*")
 I TMP=0 S ERR=1 D ERRX^DGPMAPIE(.RETURN,"BEDNFND",.TXT) Q 0
 N I,WF S I="",WF=0
 F  S I=$O(TMP("W",I)) Q:I=""  S:TMP("W",I,.01,"I")=+$G(WARD) WF=1
 I 'WF S ERR=1,TXT(1)=WN,TXT(2)=TMP(.01,"E") D ERRX^DGPMAPIE(.RETURN,"WRDCNASB",.TXT) Q 0
 I $D(TMP("OOS")),'$$ISBEDACT^DGPMAPI7(.TMP,+$G(DATE)) S ERR=1 D ERRX^DGPMAPIE(.RETURN,"BEDINACT",.TXT) Q 0
 I $$ISBEDOCC^DGPMAPI7(+$G(BED),+$G(DFN)) S ERR=1 D ERRX^DGPMAPIE(.RETURN,"BEDOCC") Q 0
 S RETURN=1
 Q 1
 ;
CHKTYPE(RETURN,TYPE,DFN,DATE,MVT) ; Check type
 N TXT,ADTYP,ERR K RETURN S RETURN=0
 I $G(TYPE)="" S TXT(1)="PARAM('TYPE')" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETMVTT^DGPMDAL2(.TMP,+TYPE)
 I TMP=0 D ERRX^DGPMAPIE(.RETURN,"MVTTNFND") Q 0
 S RETURN=1
 Q 1
 ;
CHKPAT(RETURN,DFN,PARN) ; Check patient
 N TMP,TXT K RETURN S RETURN=0
 S TXT(1)=$S($G(PARN)="":"PARAM('PATIENT')",1:PARN)
 I $G(DFN)="" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETPAT^DGPMDAL2(.TMP,+DFN)
 I TMP=0 D ERRX^DGPMAPIE(.RETURN,"PATNFND") Q 0
 S RETURN=1
 Q 1
 ;
CHKAREG(RETURN,ADMREG) ; Check admitting regulation
 N TMP,TXT K RETURN S RETURN=0
 I $G(ADMREG)="" S TXT(1)="PARAM('ADMREG')" D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 D GETAREG^DGPMDAL2(.TMP,+ADMREG)
 I TMP=0 D ERRX^DGPMAPIE(.RETURN,"AREGNFND") Q 0
 I $G(TMP(4,"I"))=1 S TXT(1)=TMP(.01,"E") D ERRX^DGPMAPIE(.RETURN,"AREGINAC",.TXT) Q 0
 S RETURN=1
 Q 1
 ;
CHKREG(RETURN,PARAM,DFN,MAS) ;
 N %
 ; ward
 S %=$$CHKWARD^DGPMAPI8(.RETURN,$G(PARAM("WARD")),+PARAM("DATE")) Q:'RETURN 0
 ; roombed
 I $G(PARAM("ROOMBED"))'="" D  Q:'RETURN 0
 . S %=$$CHKBED^DGPMAPI8(.RETURN,+PARAM("ROOMBED"),+PARAM("WARD"),DFN,+PARAM("DATE"))
 ; related physical movement
 I MAS(.05,"I"),$D(PARAM("FTSPEC"))!$D(PARAM("ATNDPHY")) D  Q:'% 0
 . S %=$$CHKADD^DGPMAPI6(.RETURN,.PARAM)
 Q 1
 ;
GETWARD(RETURN,IFN) ; Get ward
 K RETURN N IND,NAME,FLDS,NAMES,WARD
 S FLDS=".01;.02;.03;.09;.017;"
 S NAMES="NAME;BED;SERVICE;SRILL;SPCTY"
 D GETWARD^DGPMDAL2(.WARD,+$G(IFN),FLDS)
 I WARD=0 M RETURN=WARD S RETURN=0 D ERRX^DGPMAPIE(.RETURN,"MVTTNFND") Q 0
 D BUILD(.RETURN,.WARD,FLDS,NAMES)
 S RETURN=1
 Q 1
 ;
CHKDT(RETURN,DATE) ; Check movement date
 N TXT
 K RETURN S RETURN=1,TXT(1)="PARAM('DATE')"
 I $G(DATE)=""!(+$G(DATE)<1800000) S RETURN=0
 S X=DATE,%DT="SXT",%DT(0)="-NOW" D ^%DT
 I $S('Y:1,Y'?7N1".".N:1,1:0) S RETURN=0
 I RETURN=0 D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 S RETURN=1
 Q 1
VALDT(RETURN,DATE,PAR,REQ) ; Valid date
 N TXT
 K RETURN S RETURN=1,TXT(1)=$G(PAR)
 I $G(DATE)="",'$G(REQ) Q 1
 I $G(DATE)=""!(+$G(DATE)<1800000) S RETURN=0
 S X=DATE,%DT="SXT" D ^%DT
 I $S('Y:1,Y'>0:1,1:0) S RETURN=0
 I RETURN=0 D ERRX^DGPMAPIE(.RETURN,"INVPARM",.TXT) Q 0
 S RETURN=1
 Q 1
